> [!tip] Связанные темы
>
> - Безопасность приложений
> - Авторизация
> - Cookie-сессия vs JWT
> - Сети, HTTP и CORS

## Что такое CSRF

CSRF (Cross-Site Request Forgery) — атака, при которой злоумышленник заставляет браузер пользователя отправить запрос на доверенный сайт от имени этого пользователя.

Ключевой момент: браузер сам прикладывает cookie к запросу, если пользователь уже авторизован.

## Когда атака возможна

Обычно нужны одновременно:

- пользователь авторизован на целевом сайте
- аутентификация завязана на cookie
- есть state-changing endpoint (`POST`, `PUT`, `PATCH`, `DELETE`)
- отсутствует защита (token/origin-check/SameSite)

## Классический сценарий

1. Пользователь залогинен в `bank.example`.
2. Открывает стороннюю страницу злоумышленника.
3. Страница отправляет скрытый `POST` на `bank.example/transfer`.
4. Браузер прикладывает cookie-сессию автоматически.
5. Если сервер не проверяет CSRF-защиту, операция выполняется.

## Как защищаться

### 1. CSRF token

Сервер выдаёт токен и требует его в каждом изменяющем запросе.

- synchronizer token pattern (сервер хранит токен в сессии)
- double submit cookie (сервер сравнивает токен из cookie и из запроса)

### 2. `SameSite` у cookie

Для сессионных cookie:

- `SameSite=Lax` или `SameSite=Strict`
- вместе с `Secure` и `HttpOnly`

Это снижает риск автоматической отправки cookie на cross-site запросах.

### 3. Проверка `Origin`/`Referer`

Для небезопасных методов полезно проверять заголовки источника и отклонять чужие origin.

### 4. Правильная семантика HTTP

`GET` не должен менять состояние.  
Если изменение состояния происходит через `GET`, CSRF-защита обходитcя слишком легко.

## CSRF и JWT

- JWT в `Authorization` header обычно не отправляется браузером автоматически, поэтому риск CSRF ниже.
- JWT в cookie снова возвращает CSRF-риски, нужна защита как для cookie-сессий.

## Практический чеклист

1. Все state-changing endpoints защищены CSRF-token.
2. Сессионные cookie: `HttpOnly`, `Secure`, `SameSite`.
3. Проверяется `Origin`/`Referer` для unsafe методов.
4. `GET` не выполняет изменения.
5. Критичные операции подтверждаются повторной аутентификацией/2FA.
